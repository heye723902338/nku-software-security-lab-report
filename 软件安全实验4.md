## 软件安全实验4

姓名：何叶 学号：2313487 班级：范玲玲班

### 一、实验名称

格式化字符串漏洞

### 二、实验内容

以第四章示例4-7代码，完成任意地址的数据获取，观察Release模式和Debug模式的差异，并进行总结。

### 三、实验过程

#### 1.实验源码：

```c
#include <stdio.h>
int main(int argc, char *argv[])
{
    char str[200];
    fgets(str,200,stdin);
    printf(str);
    return 0;
}
```

#### 2.debug模式进入

##### 2.1从ollydbg进入

<img src="C:\Users\he'ye\Pictures\Screenshots\屏幕截图 2025-04-01 105159.png" style="zoom:67%;" />

##### 2.2从main函数进入调试

<img src="C:\Users\he'ye\AppData\Roaming\Typora\typora-user-images\image-20250401110119744.png" alt="image-20250401110119744" style="zoom:67%;" />

![image-20250401110432654](C:\Users\he'ye\AppData\Roaming\Typora\typora-user-images\image-20250401110432654.png)

##### 2.3理解汇编语句作用

**push ebp//将ebp压入栈**

**mov ebp,esp//实现栈顶与栈底的转换**

**sub esp ,108//给了108的空间**

**push ebx//压入寄存器**

**push esi//压入寄存器**

**push edi//压入寄存器**

**lea edi,[ebp-108]//取地址**

**mov eax,42//**

**mov eax,cccccccc//将给的空间中全部赋值为CCCCCCCC**

**![image-20250401111804843](C:\Users\he'ye\AppData\Roaming\Typora\typora-user-images\image-20250401111804843.png)**

**观察到空间全部赋值为CCCCCCCC**

**call fget//调用fget函数**

**![image-20250401112917053](C:\Users\he'ye\AppData\Roaming\Typora\typora-user-images\image-20250401112917053.png)**

**输入AAAA%X%X%X%X:**

**![image-20250401114138398](C:\Users\he'ye\AppData\Roaming\Typora\typora-user-images\image-20250401114138398.png)**

**![image-20250401114151091](C:\Users\he'ye\AppData\Roaming\Typora\typora-user-images\image-20250401114151091.png)**

**可以看到已经将AAAA%X%X%X%X压入**

**add esp,0c//清除fget的栈帧**

**lea exc,[ebp-0c8]//将str的起始地址保存在ecx**

**call printf//执行printf函数**

**返回：AAAABB425A30FFFFFFFE15**

**解释：**

**printf函数正常输出AAAA，遇到%X时，读取并输出后面的地址，即000000BB,00425A30,FFFFFFFE,00000015;**

**输出为：AAAABB425A30FFFFFFFE15**

#### 3.从release模式进入

##### 3.1从ollydbg进入

![image-20250401143551677](C:\Users\he'ye\AppData\Roaming\Typora\typora-user-images\image-20250401143551677.png)

观察到分配紧凑，代码紧靠

##### 3.2找到main函数入口

![image-20250401144115939](C:\Users\he'ye\AppData\Roaming\Typora\typora-user-images\image-20250401144115939.png)

##### 3.3进入主函数

![image-20250401144214280](C:\Users\he'ye\AppData\Roaming\Typora\typora-user-images\image-20250401144214280.png)

**观察到没有ebp入栈**

**sub esp,0C8//抬高200字节，仅仅给局部变量分配了空间**

**没有debug中一堆push寄存器的值**

**lea eax,[esp]//esp的地址给eax**

**push offset 00407030//参数入栈调用**

**push 0c8//参数入栈调用**

**push eax//参数入栈调用**

##### 3.4进入fgets函数

![image-20250401145119081](C:\Users\he'ye\AppData\Roaming\Typora\typora-user-images\image-20250401145119081.png)

输入AAAA%X%X%X%X

![image-20250401145247147](C:\Users\he'ye\AppData\Roaming\Typora\typora-user-images\image-20250401145247147.png)

观察到参数入栈

![image-20250401145405473](C:\Users\he'ye\AppData\Roaming\Typora\typora-user-images\image-20250401145405473.png)

##### 3.5printf函数

![image-20250401145525718](C:\Users\he'ye\AppData\Roaming\Typora\typora-user-images\image-20250401145525718.png)

输出结果为AAAA12FEBCBB40703041414141

先输出AAAA，四个%X输出后四行的地址值，即0012FEBC,000000BB,00407030,41414141

#### 4.debug模式与release模式的区别

##### 4.1debug模式

main函数分配更大的栈空间，从EBP附近位置分配空间

##### 4.2release模式

代码更加紧凑，简洁，效率更高

进入main函数时，没有严格栈帧转换，不初始化栈空间，没有 push eax来保存寄存器的值，程序最后add esp ,0D8来恢复栈帧

##### 4.3总结

Debug模式主要用于开发和调试，包含调试信息，支持断点调试，代码优化少，运行速度慢，资源占用多，生成的代码可读性强，便于查找和修复问题。Release模式用于发布最终产品，不包含调试信息，不支持断点调试，代码优化程度高，运行速度快，资源占用少，生成的代码复杂度高，适合实际运行环境。

| **维度**     | **Debug 模式**     | **Release 模式**         |
| ------------ | ------------------ | ------------------------ |
| **优化**     | 无优化，便于调试   | 高度优化，提升性能       |
| **调试信息** | 包含完整调试信息   | 通常不包含或少量调试信息 |
| **性能**     | 性能较低           | 性能最佳                 |
| **文件大小** | 文件较大           | 文件较小                 |
| **断言**     | 启用断言和检查功能 | 禁用断言，提升性能       |
| **用途**     | 开发和调试阶段     | 最终发布给用户           |

### 四、心得体会

从汇编语言的角度分析debug模式和release模式的区别，更加深入了解两种模式不同的应用场景和原因

%X攻击，格式化字符完成任意地址的数据获取，说明我们需要考虑程序的安全，需要给输入加一些限制条件来避免发生这种情况

