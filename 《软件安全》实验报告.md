## 《软件安全》实验报告

姓名：何叶  学号：2313487 班级：范玲玲班

### 一、实验名称

堆溢出Dword Shoot攻击实验

### 二、实验要求

 以第四章示例4-4代码为准，在VC IDE中进行调试，观察堆管理结构，记录Unlink节点时的双向空闲链表的状态变化，了解堆溢出漏洞下的Dword Shoot攻击。

### 三、实验过程

#### 1.从源码进入反汇编模式

<img src="C:\Users\he'ye\AppData\Roaming\Typora\typora-user-images\image-20250320104933375.png" alt="image-20250320104933375" style="zoom:50%;" />

<img src="C:\Users\he'ye\AppData\Roaming\Typora\typora-user-images\image-20250320105055430.png" alt="image-20250320105055430" style="zoom: 50%;" />

整个流程解析：
(1)程序首先创建了一个大小为0x1000的堆区,并从其中连续申请了6个块身大小为8 字节的堆块,加上块首实际上是6个16字节的堆块。
(2)释放奇数次申请的堆块是为了防止堆块合并的发生。
(3)3次释放结束后,会形成3个16字节的空闲堆块放入空表。因为是16字节,所以会被依次放入freelist[2]所标识的空表,它们依次是h1、h3、h5。
(4)再次申请8字节的堆区内存,加上块首是16字节,因此会从freelist[2]所标识的空表中摘取第一个空闲堆块,即h1。
(5)如果手动修改h1块首中的指针,应该能够观察到Dword Shoot 攻击的发生。

#### 2.观察堆管理结构

<img src="C:\Users\he'ye\Desktop\软件安全作业\《软件安全》实验报告.assets\image-20250326193133515.png" alt="image-20250326193133515" style="zoom:67%;" />

打断点进入调试反汇编，看到h1的地址为0x003a0688,块首地址为0x003a0680;

<img src="C:\Users\he'ye\Desktop\软件安全作业\《软件安全》实验报告.assets\image-20250326193309429.png" alt="image-20250326193309429" style="zoom:67%;" />

按f10跳转，看0x3a0680地址，其中，flink和blink都为003a0198，指向同一个地址，该地址即为freelist[2];

![image-20250326193446521](C:\Users\he'ye\Desktop\软件安全作业\《软件安全》实验报告.assets\image-20250326193446521.png)

跳转003a0198地址，看到freelist[2]的flink和blink都指向003a0688，为h1释放的地址，freelist中链入了h1的空闲堆块；

<img src="C:\Users\he'ye\Desktop\软件安全作业\《软件安全》实验报告.assets\image-20250326193553825.png" alt="image-20250326193553825" style="zoom: 80%;" />

按f10释放h3后，观察003a0680，h1的flink改变为h3的堆块地址003a06c8；

跳转入003a06c8后观察到flink指向freelist[2]，blink指向h1的堆块块身；

![image-20250326193824770](C:\Users\he'ye\Desktop\软件安全作业\《软件安全》实验报告.assets\image-20250326193824770.png)

![image-20250326194131376](C:\Users\he'ye\Desktop\软件安全作业\《软件安全》实验报告.assets\image-20250326194131376.png)

释放h5，查看h3块身地址，flink指向h5地址；

观察h5的地址，flink指向freelist[2],blink指向h3地址；

此时，各堆块：

<img src="C:\Users\he'ye\Desktop\软件安全作业\《软件安全》实验报告.assets\image-20250326200805426.png" alt="image-20250326200805426" style="zoom: 50%;" />

相当于freelisat[2],h1,h3,h5的双向链表；

<img src="C:\Users\he'ye\Desktop\软件安全作业\《软件安全》实验报告.assets\image-20250326194053267.png" alt="image-20250326194053267" style="zoom: 80%;" />

![image-20250326194131376](C:\Users\he'ye\Desktop\软件安全作业\《软件安全》实验报告.assets\image-20250326194131376.png)

按f10，重新分配一个块身为8字节的堆来取下h1地址，观察freelist[2]地址，此时flink变为h3地址，说明h1的flink写入h1的blink；

观察003a06c8，h3的blink变为freelist[2],说明h1的blink写入h1的flink；

卸下一个堆块的时候，会将其flink和blink的值写入到其指向的内存当中，因此我们可以利用这个来实现一次`Dword Shoot`攻击。

### 四、心得体会

​     在本次实验中，我掌握了在VC6环境下堆的创建与释放方法，并且意识到到栈溢出和堆溢出的危害性。通过追踪堆块内存位置，我对堆表的内存管理机制有了更深入的理解，包括堆表合并、空闲表链接等关键知识点，以及flink和blink两个指针的变化规律。同时，我掌握了Dword Shoot攻击的原理，即通过构造特定地址和数据，在空闲堆块从链表中移除的瞬间，获得向任意内存地址写入任意数据的机会。
